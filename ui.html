<head>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #fafafa;
    min-height: 100vh;
    padding: 24px;
    color: #333;
    line-height: 1.5;
  }

  .container {
    max-width: 420px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    padding: 32px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e5e5;
  }

  h2 {
    text-align: center;
    color: #1a1a1a;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .puzzle-icon {
    font-size: 24px;
    opacity: 0.7;
  }

  .form-group {
    margin-bottom: 24px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
    font-size: 14px;
  }

  .input-row {
    display: flex;
    gap: 16px;
  }

  .input-row .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  input[type="number"], input[type="file"] {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s ease;
    background: #fff;
  }

  input[type="number"]:focus, input[type="file"]:focus {
    outline: none;
    border-color: #666;
  }

  input[type="file"] {
    cursor: pointer;
    padding: 16px;
    text-align: center;
    border: 2px dashed #ddd;
    background: #fafafa;
  }

  input[type="file"]:hover {
    background: #f0f0f0;
    border-color: #999;
  }

  .preview-container {
    margin: 24px 0;
  }

  .preview-box {
    background: #fafafa;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    text-align: center;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-box:not(:empty) {
    background: white;
  }

  .preview-box img {
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }



  button {
    width: 100%;
    padding: 16px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 12px;
  }

  #create {
    background: #1a1a1a;
    color: white;
  }

  #create:hover {
    background: #333;
  }

  #create:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  #debug {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #e5e5e5;
    font-size: 14px;
  }

  #debug:hover {
    background: #e5e5e5;
  }

  /* Puzzle grid visual elements */
  .grid-visual {
    display: inline-block;
    width: 12px;
    height: 12px;
    background: currentColor;
    opacity: 0.3;
    margin: 0 2px;
    border-radius: 2px;
  }

  .empty-state {
    color: #999;
    font-size: 14px;
    font-style: italic;
  }

  /* Clean puzzle piece preview grid */
  .puzzle-grid {
    display: block;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    margin: 0 auto;
    width: fit-content;
    max-width: 100%;
  }

  .puzzle-row {
    display: flex;
    line-height: 0;
  }

  .puzzle-grid img {
    display: block;
    margin: 0;
    border: 0;
    border-right: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    flex-shrink: 0;
  }

  .puzzle-row img:last-child {
    border-right: none;
  }

  .puzzle-row:last-child img {
    border-bottom: none;
  }
</style>
</head>

<body>
<div class="container">
  <h2>
    <span class="puzzle-icon">ðŸ§©</span>
    Puzzle Creator
  </h2>
  
  <div class="input-row">
    <div class="form-group">
      <label for="rows">Rows</label>
      <input id="rows" type="number" value="4" min="1" max="10">
    </div>
    
    <div class="form-group">
      <label for="columns">Columns</label>
      <input id="columns" type="number" value="3" min="1" max="10">
    </div>
  </div>
  
  <div class="form-group">
    <label for="image">Upload Image</label>
    <input id="image" type="file" accept="image/*" placeholder="Choose image file">
  </div>
  
  <div class="preview-container">
    <div id="image-preview" class="preview-box">
      <span class="empty-state">Image preview will appear here</span>
    </div>
    <div id="puzzle-preview" class="preview-box">
      <span class="empty-state">Puzzle preview will appear here</span>
    </div>
  </div>

  <button id="create">Create Puzzle</button>
  <button id="debug">Debug</button>
</div>

<script>

let currentImage = null;
let puzzlePieces = [];

// Handle image preview and puzzle piece generation
document.getElementById('image').onchange = (event) => {
  const file = event.target.files[0];
  const preview = document.getElementById('image-preview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        currentImage = img;
        preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 100px;">`;
        generatePuzzlePreview();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = '<span class="empty-state">Image preview will appear here</span>';
    document.getElementById('puzzle-preview').innerHTML = '<span class="empty-state">Puzzle preview will appear here</span>';
    currentImage = null;
    puzzlePieces = [];
  }
};

// Update puzzle preview when rows/columns change
document.getElementById('rows').onchange = generatePuzzlePreview;
document.getElementById('columns').onchange = generatePuzzlePreview;

function generatePuzzlePreview() {
  if (!currentImage) return;
  
  const rows = parseInt(document.getElementById('rows').value, 10);
  const columns = parseInt(document.getElementById('columns').value, 10);
  const puzzlePreview = document.getElementById('puzzle-preview');
  
  // Create canvas to crop image pieces
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // Calculate piece dimensions
  const pieceWidth = currentImage.width / columns;
  const pieceHeight = currentImage.height / rows;
  
  canvas.width = pieceWidth;
  canvas.height = pieceHeight;
  
  puzzlePieces = [];
  
  // Calculate preview dimensions while maintaining aspect ratio
  const maxPreviewWidth = 300; // Increased max width for better grid display
  const aspectRatio = currentImage.width / currentImage.height;
  let previewWidth, previewHeight;
  
  if (aspectRatio > 1) {
    previewWidth = Math.min(maxPreviewWidth, currentImage.width);
    previewHeight = previewWidth / aspectRatio;
  } else {
    previewHeight = Math.min(maxPreviewWidth, currentImage.height);
    previewWidth = previewHeight * aspectRatio;
  }
  
  const previewPieceWidth = previewWidth / columns;
  const previewPieceHeight = previewHeight / rows;
  
  let previewHTML = '<div class="puzzle-grid">';
  
  for (let row = 0; row < rows; row++) {
    previewHTML += '<div class="puzzle-row">';
    for (let col = 0; col < columns; col++) {
      // Clear canvas
      ctx.clearRect(0, 0, pieceWidth, pieceHeight);
      
      // Draw the cropped piece
      ctx.drawImage(
        currentImage,
        col * pieceWidth, row * pieceHeight, pieceWidth, pieceHeight,
        0, 0, pieceWidth, pieceHeight
      );
      
      // Convert to blob and store
      const pieceDataURL = canvas.toDataURL('image/png');
      puzzlePieces.push({
        row: row,
        col: col,
        dataURL: pieceDataURL
      });
      
      // Add to preview with correct proportions
      previewHTML += `<img src="${pieceDataURL}" style="width: ${previewPieceWidth}px; height: ${previewPieceHeight}px; display: inline-block;">`;
    }
    previewHTML += '</div>';
  }
  previewHTML += '</div>';
  
  puzzlePreview.innerHTML = previewHTML;
}

document.getElementById('create').onclick = async () => {
  const rows = parseInt(document.getElementById('rows').value, 10);
  const columns = parseInt(document.getElementById('columns').value, 10);
  
  if (currentImage) {
    const fileInput = document.getElementById('image');
    const file = fileInput.files[0];
    const imageData = await file.arrayBuffer();
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'create-puzzle', 
        rows, 
        columns, 
        imageData: imageData,
        originalImageWidth: currentImage.width,
        originalImageHeight: currentImage.height
      } 
    }, '*');
  } else {
    // No image selected, proceed without image
    parent.postMessage({ 
      pluginMessage: { 
        type: 'create-shapes', 
        rows, 
        columns 
      } 
    }, '*');
  }
}

document.getElementById('debug').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'debug' } }, '*')
}

</script>
</body>
